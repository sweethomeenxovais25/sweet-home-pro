st.markdown("### üîç Ficha de Cliente (Extrato Din√¢mico)")
    opcoes_ficha = sorted([f"{k} - {v['nome']}" for k, v in banco_de_clientes.items()])
    sel_ficha = st.selectbox("Selecione para ver o que ela deve:", ["---"] + opcoes_ficha, key="ficha_sel_cliente")
    
    if sel_ficha != "---":
        id_c = sel_ficha.split(" - ")[0]
        nome_c_ficha = " - ".join(sel_ficha.split(" - ")[1:])
        v_hist = df_vendas_hist[df_vendas_hist['C√ìD. CLIENTE'].astype(str) == id_c]
        
        # Cria uma coluna num√©rica tempor√°ria para facilitar a soma e o filtro
        v_hist['SALDO_NUM'] = v_hist['SALDO DEVEDOR'].apply(limpar_v)
        saldo_devedor_real = v_hist['SALDO_NUM'].sum()
        
        c_f1, c_f2 = st.columns(2)
        c_f1.metric("Saldo Devedor Atual", f"R$ {saldo_devedor_real:,.2f}")
        
        if saldo_devedor_real > 0.01:
            # ---------------------------------------------------------
            # 1. BUSCA INTELIGENTE DO N√öMERO NA CARTEIRA DE CLIENTES
            # ---------------------------------------------------------
            dados_cliente = banco_de_clientes.get(id_c, {})
            telefone_cru = str(dados_cliente.get('TELEFONE', dados_cliente.get('telefone', dados_cliente.get('fone', ''))))
            
            # Limpa tudo que n√£o for n√∫mero e garante o 55 do Brasil
            tel_c = "".join(filter(str.isdigit, telefone_cru))
            if tel_c and not tel_c.startswith("55"): 
                tel_c = "55" + tel_c

            # ---------------------------------------------------------
            # 2. CONSTRU√á√ÉO DO RECIBO FINANCEIRO (TEXTO PURO PARA O WPP)
            # ---------------------------------------------------------
            lista_extrato = ""
            
            # Varre TODO o hist√≥rico com visual de Ticket (Sem Emojis para o WPP)
            for _, row in v_hist.iterrows():
                status_atual = str(row['STATUS']).strip()
                
                # Farol em Texto Puro
                if status_atual.lower() in ['pago', 'quitado', 'ok']:
                    icone = "[ PAGO ]"
                else:
                    icone = "[ PENDENTE ]"
                
                # Estrutura visual textual para o WhatsApp
                lista_extrato += f"*{row['PRODUTO']}*\n ‚îú Data: {row['DATA DA VENDA']}\n ‚îî Status: {icone}\n\n"
            
            saldo_formatado = f"R$ {saldo_devedor_real:,.2f}".replace(",", "X").replace(".", ",").replace("X", ".")
            
            # MENSAGEM 1: COBRAN√áA (Texto Puro, Sem Emojis)
            msg_cobranca = (
                f"Ol√°, *{nome_c_ficha}*! Tudo bem?\n\n"
                f"Aqui √© do *Setor Financeiro da Sweet Home Enxovais*.\n"
                f"Criamos esse departamento recentemente para melhorar a nossa organiza√ß√£o e estarmos ainda mais pr√≥ximos de voc√™!\n\n"
                f"Passando para deixar o resumo atualizado da sua ficha conosco:\n\n"
                f"*HIST√ìRICO DE COMPRAS:*\n"
                f"-----------------------------------\n"
                f"{lista_extrato}"
                f"-----------------------------------\n"
                f"*Total Pendente Atual: {saldo_formatado}*\n\n"
                f"Qualquer d√∫vida sobre os itens ou se precisar da nossa chave PIX para regularizar, estou √† disposi√ß√£o!"
            )

            # MENSAGEM 2: LEMBRETE PREVENTIVO (Texto Puro, Sem Emojis)
            msg_lembrete = (
                f"Ol√°, *{nome_c_ficha}*! Tudo bem?\n\n"
                f"Aqui √© do *Setor Financeiro da Sweet Home Enxovais*.\n\n"
                f"Passando apenas para te enviar um lembrete super amig√°vel de que voc√™ tem itens com vencimento se aproximando.\n\n"
                f"*RESUMO DA SUA FICHA:*\n"
                f"-----------------------------------\n"
                f"{lista_extrato}"
                f"-----------------------------------\n"
                f"*Valor programado para acerto: {saldo_formatado}*\n\n"
                f"Se precisar da nossa chave PIX para j√° deixar agendado, √© s√≥ me avisar. Tenha um excelente dia!"
            )
            
            # ---------------------------------------------------------
            # 3. EXIBI√á√ÉO DOS BOT√ïES LADO A LADO (Bypass com HTML Puro)
            # ---------------------------------------------------------
            if tel_c:
                st.write("#### üéØ Escolha a abordagem:")
                col_btn1, col_btn2 = st.columns(2)
                
                # Voltamos para o quote normal, o HTML vai cuidar do resto
                url_cob = f"https://wa.me/{tel_c}?text={urllib.parse.quote(msg_cobranca)}"
                url_prev = f"https://wa.me/{tel_c}?text={urllib.parse.quote(msg_lembrete)}"
                
                # Criando bot√µes com HTML/CSS para driblar o bloqueio do Streamlit
                btn_cob_html = f"""<a href="{url_cob}" target="_blank" style="display: block; width: 100%; text-align: center; background-color: #ff4b4b; color: white; padding: 10px; border-radius: 8px; text-decoration: none; font-weight: bold;">üö® Enviar Cobran√ßa (Atrasados)</a>"""
                
                btn_prev_html = f"""<a href="{url_prev}" target="_blank" style="display: block; width: 100%; text-align: center; background-color: #262730; color: white; padding: 10px; border-radius: 8px; text-decoration: none; font-weight: bold;">üìÖ Enviar Lembrete (Preventivo)</a>"""
                
                with col_btn1:
                    st.markdown(btn_cob_html, unsafe_allow_html=True)
                
                with col_btn2:
                    st.markdown(btn_prev_html, unsafe_allow_html=True)
                
                # ---------------------------------------------------------
                # 4. M√ìDULO DE IA SOB DEMANDA
                # ---------------------------------------------------------
                st.markdown("---")
                st.write("‚ú® **Precisa de uma abordagem diferente?**")
                
                if st.button("ü§ñ Personalizar mensagem com IA", use_container_width=True):
                    st.session_state['ia_ficha_ativa'] = True
                    
                if st.session_state.get('ia_ficha_ativa', False):
                    tipo_ia = st.radio("Qual mensagem voc√™ quer que a IA reescreva?", ["Cobran√ßa", "Lembrete Preventivo"])
                    msg_base_ia = msg_cobranca if tipo_ia == "Cobran√ßa" else msg_lembrete
                    
                    with st.spinner("ü§ñ Consultando a IA (Modo Seguro)..."):
                        try:
                            import google.generativeai as genai
                            genai.configure(api_key=st.secrets["GOOGLE_API_KEY"])
                            
                            prompt = f"""
                            Voc√™ atua no Setor Financeiro da 'Sweet Home Enxovais'. 
                            Reescreva a mensagem abaixo para deix√°-la incrivelmente emp√°tica e persuasiva, mas sem perder a educa√ß√£o. 
                            MANTENHA INTACTA a lista de produtos (o hist√≥rico com as datas) e o valor final.
                            
                            ‚ö†Ô∏è REGRA CR√çTICA: Retorne EXATAMENTE APENAS o texto da mensagem final. 
                            N√ÉO inclua introdu√ß√µes como "Com certeza!", "Aqui est√°..." ou tracejados iniciais. 
                            N√ÉO explique o que voc√™ fez. O texto deve estar pronto para eu copiar e colar diretamente no WhatsApp.
                            Voc√™ PODE e DEVE utilizar emojis estrat√©gicos para deixar a mensagem amig√°vel e simp√°tica.
                            
                            Mensagem:
                            {msg_base_ia}
                            """
                            
                            # üí° AJUSTE DA IA: Removido o modelo velho (pro) e inserido o tradutor de limites (429)
                            modelos = ["gemini-2.0-flash"]
                            resultado_ia = None
                            erro_google = ""
                            
                            for m in modelos:
                                try:
                                    modelo_gen = genai.GenerativeModel(m)
                                    resultado_ia = modelo_gen.generate_content(prompt)
                                    if resultado_ia:
                                        break
                                except Exception as e:
                                    erro_str = str(e)
                                    if "429" in erro_str or "quota" in erro_str.lower():
                                        erro_google = "‚è≥ Limite de consultas r√°pidas atingido. Por favor, aguarde 30 segundos e clique novamente."
                                    else:
                                        erro_google = erro_str
                                    continue
                                
                            if resultado_ia:
                                st.success("‚ú® Mensagem Otimizada com Sucesso!")
                                texto_final_ia = st.text_area("Revise a mensagem da IA:", value=resultado_ia.text.strip(), height=250)
                                
                                # Bot√£o Nativo (st.link_button) para garantir que os Emojis gerados pela IA n√£o quebrem
                                url_ia = f"https://wa.me/{tel_c}?text={urllib.parse.quote(texto_final_ia)}"
                                st.link_button("üì≤ Enviar Mensagem da IA", url_ia, use_container_width=True, type="primary")
                                
                                st.write("") # Espa√ßinho visual
                                if st.button("‚ùå Dispensar IA"):
                                    st.session_state['ia_ficha_ativa'] = False
                                    st.rerun()
                            else:
                                st.error(f"‚ö†Ô∏è {erro_google}" if erro_google else "‚ö†Ô∏è Nenhum modelo de IA suportou a requisi√ß√£o no momento.")
                        except Exception as e_ia:
                            st.error(f"‚ö†Ô∏è Erro de comunica√ß√£o com o Google: {e_ia}")

            else:
                st.error("‚ö†Ô∏è Telefone n√£o localizado na base desta cliente.")
                
        else: 
            st.success("‚úÖ Esta cliente n√£o possui d√©bitos pendentes.")

        st.write("#### ‚è≥ Hist√≥rico de Vendas Localizado")
        if not v_hist.empty:
            st.dataframe(v_hist[['DATA DA VENDA', 'PRODUTO', 'TOTAL R$', 'SALDO DEVEDOR', 'STATUS']], use_container_width=True, hide_index=True)
        else: 
            st.info("Nenhuma compra registrada para esta cliente ainda.")
